"use strict";const config={networkUrl:{main:"https://service.goldmint.io/sumus/mainnet/v1",test:"https://service.goldmint.io/sumus/testnet/v1"},checkTxUrl:"/tx/",addTxUrl:"/tx",successTxStatus:"approved",staleTxStatus:"stale",checkTxTime:3e4};let isFirefox="undefined"!=typeof InstallTrigger,brows=isFirefox?browser:chrome,xhr=new XMLHttpRequest,wallets=[],txQueue={};function actions(e,t){e.identify&&login(e),e.logout&&logout(),e.checkLoginStatus&&sendMessage("loginStatus",!!window.sessionStorage.getItem("identify")),e.newTransaction&&watchTransactionStatus(!1),e.sendTransaction&&createConfirmWindow(e.sendTransaction,t.tab.id),e.hasOwnProperty("sendTxResult")&&(brows.tabs.query({active:!0,currentWindow:!0},t=>{brows.tabs.sendMessage(+e.sendTxResult.tabId,{sendTxResultContent:e.sendTxResult})}),e.sendTxResult&&watchTransactionStatus(!1)),e.getIdentifier&&sendMessage("identifier",window.sessionStorage.getItem("identify")),e.openSendTokenPage&&openSendTokenPage()}function login(e){window.sessionStorage.setItem("identify",e.identify),sendMessage("login",!0)}function logout(){window.sessionStorage.removeItem("identify"),sendMessage("login",!1)}function sendMessage(e,t){brows.tabs.query({active:!0,currentWindow:!0},n=>{brows.tabs.sendMessage(n[0].id,{[e]:t})})}function watchTransactionStatus(e){brows.storage.local.get(null,t=>{(wallets=t.wallets)&&wallets.forEach(t=>{if(t.tx){const n=t.tx.hash,s=t.tx.endTime,i=t.tx.network,o=t.tx.data;let a=!1;if(Object.keys(txQueue).forEach(e=>{e===n&&(a=!0)}),!a){const t=setInterval(()=>{checkTransactionStatus(n,s,i,o)},config.checkTxTime);txQueue[n]=t,e&&checkTransactionStatus(n,s,i,o)}}})})}function checkTransactionStatus(e,t,n,s){(new Date).getTime()<t?http("GET",config.networkUrl[n]+config.checkTxUrl+e).then(t=>{t&&t.res&&(t.res.status==config.successTxStatus?(finishTx(e),successTxNotification(e)):t.res.status==config.staleTxStatus&&http("POST",config.networkUrl[n]+config.addTxUrl,{name:s.name,data:s.data}).then(t=>{!t&&finishTx(e)}))}):(finishTx(e),failedTxNotification(e))}function http(e,t,n=""){let s=new XMLHttpRequest,i="GET"===e.toUpperCase()?t+n:t;return s.open(e.toUpperCase(),i,!0),s.setRequestHeader("Content-Type","application/json"),"GET"===e.toUpperCase()?s.send():s.send(JSON.stringify(n)),new Promise((e,t)=>{s.onload=(()=>{if(s.status>=200&&s.status<300)try{e(JSON.parse(s.responseText))}catch(t){e(null)}else e(null)})})}function finishTx(e){clearInterval(txQueue[e]),delete txQueue[e],wallets=wallets.map(t=>(t.tx&&t.tx.hash===e&&delete t.tx,t)),brows.storage.local.set({wallets:wallets},()=>{})}function successTxNotification(e){new Notification("Goldmint Lite Wallet",{icon:"assets/icon.png",body:`Transaction ${e} is confirmed`})}function failedTxNotification(e){new Notification("Goldmint Lite Wallet",{icon:"assets/icon.png",body:`Transaction ${e} is failed`})}function createConfirmWindow(e,t){brows.windows.create({url:`confirm-tx.html?id=${e}&tabId=${t}`,type:"popup",width:300,height:520},e=>{})}function openSendTokenPage(){brows.tabs.create({active:!0,url:"index.html"},null)}isFirefox?brows.runtime.onMessage.addListener((e,t,n)=>{actions(e,t)}):brows.extension.onMessage.addListener((e,t,n)=>{actions(e,t)}),watchTransactionStatus(!0);
