"use strict";const config={networkUrl:{main:"https://service.goldmint.io/sumus/mainnet/v1",test:"https://service.goldmint.io/sumus/testnet/v1"},checkTxUrl:"/tx/",successTxStatus:"approved",checkTxTime:3e4};let isFirefox="undefined"!=typeof InstallTrigger,brows=isFirefox?browser:chrome,xhr=new XMLHttpRequest,wallets=[],txQueue={};function actions(e,t){e.identify&&login(e),e.logout&&logout(),e.checkLoginStatus&&sendMessage("loginStatus",!!window.sessionStorage.getItem("identify")),e.newTransaction&&watchTransactionStatus(!1),e.sendTransaction&&createConfirmWindow(e.sendTransaction,t.tab.id),e.hasOwnProperty("sendTxResult")&&(brows.tabs.query({active:!0,currentWindow:!0},t=>{brows.tabs.sendMessage(+e.sendTxResult.tabId,{sendTxResultContent:e.sendTxResult})}),e.sendTxResult&&watchTransactionStatus(!1)),e.getIdentifier&&sendMessage("identifier",window.sessionStorage.getItem("identify"))}function login(e){window.sessionStorage.setItem("identify",e.identify),sendMessage("login",!0)}function logout(){window.sessionStorage.removeItem("identify"),sendMessage("login",!1)}function sendMessage(e,t){brows.tabs.query({active:!0,currentWindow:!0},s=>{brows.tabs.sendMessage(s[0].id,{[e]:t})})}function watchTransactionStatus(e){brows.storage.local.get(null,t=>{(wallets=t.wallets)&&wallets.forEach(t=>{if(t.tx){const s=t.tx.hash,n=t.tx.endTime,i=t.tx.network;let o=!1;if(Object.keys(txQueue).forEach(e=>{e===s&&(o=!0)}),!o){const t=setInterval(()=>{checkTransactionStatus(s,n,i)},config.checkTxTime);txQueue[s]=t,e&&checkTransactionStatus(s,n,i)}}})})}function checkTransactionStatus(e,t,s){(new Date).getTime()<t?(xhr.open("GET",config.networkUrl[s]+config.checkTxUrl+e,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(),xhr.onload=(()=>{try{JSON.parse(xhr.responseText).res.status==config.successTxStatus&&(finishTx(e),successTxNotification(e))}catch(e){}})):(finishTx(e),failedTxNotification(e))}function finishTx(e){clearInterval(txQueue[e]),delete txQueue[e],wallets=wallets.map(t=>(t.tx&&t.tx.hash===e&&delete t.tx,t)),brows.storage.local.set({wallets:wallets},()=>{})}function successTxNotification(e){new Notification("Goldmint Lite Wallet",{icon:"assets/icon.png",body:`Transaction ${e} is confirmed`})}function failedTxNotification(e){new Notification("Goldmint Lite Wallet",{icon:"assets/icon.png",body:`Transaction ${e} is failed`})}function createConfirmWindow(e,t){brows.windows.create({url:`confirm-tx.html?id=${e}&tabId=${t}`,type:"popup",width:300,height:520},e=>{})}isFirefox?brows.runtime.onMessage.addListener((e,t,s)=>{actions(e,t)}):brows.extension.onMessage.addListener((e,t,s)=>{actions(e,t)}),watchTransactionStatus(!0);