"use strict";const config={networkUrl:{main:"https://service.goldmint.io/sumus/mainnet/v1",test:"https://service.goldmint.io/sumus/testnet/v1"},checkTxUrl:"/tx/",addTxUrl:"/tx",blockChainStatus:"/status",successTxStatus:"approved",staleTxStatus:"stale",checkTxTime:3e4};let isFirefox="undefined"!=typeof InstallTrigger,brows=isFirefox?browser:chrome,xhr=new XMLHttpRequest;function actions(t,e){t.identify&&login(t),t.logout&&logout(),t.checkLoginStatus&&sendMessage("loginStatus",!!window.sessionStorage.getItem("identify")),t.sendTransaction&&createConfirmWindow(t.sendTransaction,e.tab.id),t.getIdentifier&&sendMessage("identifier",window.sessionStorage.getItem("identify")),t.openSendTokenPage&&openSendTokenPage()}function login(t){window.sessionStorage.setItem("identify",t.identify),sendMessage("login",!0)}function logout(){window.sessionStorage.removeItem("identify"),sendMessage("login",!1)}function sendMessage(t,e){brows.tabs.query({active:!0,currentWindow:!0},n=>{brows.tabs.sendMessage(n[0].id,{[t]:e})})}function watchTransactionStatus(){brows.storage.local.get(null,t=>{let e=t.wallets,n=!0,s={main:0,test:0},o=!1;if(e&&e.forEach(t=>{t.tx&&t.tx.length&&(n=!1)}),n)return;const i=http("GET",config.networkUrl.main+config.blockChainStatus),a=http("GET",config.networkUrl.test+config.blockChainStatus);Promise.all([i,a]).then(t=>{t&&t.forEach((t,e)=>{t&&t.res&&t.res.blockchain_state&&t.res.blockchain_state.block_count?s[Object.keys(s)[e]]=+t.res.blockchain_state.block_count-1:o=!0})}),!o&&e&&e.forEach(t=>{t.tx&&t.tx.forEach(t=>{setTimeout(()=>{checkTransactionStatus(t.hash,t.endTime,t.network,t.data,t.blockId,s[t.network])},200)})})})}function checkTransactionStatus(t,e,n,s,o,i){(new Date).getTime()<e?http("GET",config.networkUrl[n]+config.checkTxUrl+t).then(e=>{e&&e.res&&(e.res.status==config.successTxStatus?(finishTx(t),successTxNotification(t)):+o!=+i&&http("POST",config.networkUrl[n]+config.addTxUrl,{name:s.name,data:s.data}).then(()=>{brows.storage.local.get(null,e=>{let n=e.wallets;n=n.map(e=>(e.tx&&e.tx.hash===t&&(e.tx.blockId=i),e)),brows.storage.local.set({wallets:n},()=>{})})}).catch(e=>{let n=!1;e.res&&(e.res.code?42!=e.res.code&&43!=e.res.code&&(n=!0):n=!0),n||(finishTx(t),failedTxNotification(t))}))}):(finishTx(t),failedTxNotification(t))}function http(t,e,n=""){let s=new XMLHttpRequest,o="GET"===t.toUpperCase()?e+n:e;return s.open(t.toUpperCase(),o,!0),s.setRequestHeader("Content-Type","application/json"),"GET"===t.toUpperCase()?s.send():s.send(JSON.stringify(n)),new Promise((t,e)=>{s.onload=(()=>{if(s.status>=200&&s.status<300)try{t(JSON.parse(s.responseText))}catch(e){t(null)}else try{e(JSON.parse(s.responseText))}catch(e){t(null)}})})}function finishTx(t){brows.storage.local.get(null,e=>{let n=e.wallets;n&&(n=n.map(e=>(e.tx&&e.tx.length&&(e.tx=e.tx.filter(e=>e.hash!=t)),e)),brows.storage.local.set({wallets:n},()=>{}))})}function successTxNotification(t){new Notification("Goldmint Lite Wallet",{icon:"assets/icon.png",body:`Transaction ${t} is confirmed`})}function failedTxNotification(t){new Notification("Goldmint Lite Wallet",{icon:"assets/icon.png",body:`Transaction ${t} is failed`})}function createConfirmWindow(t,e){brows.windows.create({url:`confirm-tx.html?id=${t}&tabId=${e}`,type:"popup",width:300,height:520},t=>{})}function openSendTokenPage(){brows.tabs.create({active:!0,url:"index.html"},null)}isFirefox?brows.runtime.onMessage.addListener((t,e,n)=>{actions(t,e)}):brows.extension.onMessage.addListener((t,e,n)=>{actions(t,e)}),watchTransactionStatus(),setInterval(()=>{watchTransactionStatus()},config.checkTxTime);
